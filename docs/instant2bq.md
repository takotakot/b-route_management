# instant2bq ドキュメント

本ドキュメントは、スマートメーター等の電力計測デバイスから取得され、Google Cloud Pub/Sub へと送信された「瞬間電力量データ」を、BigQuery へ効率的かつ安定的に保存するためのシステムの仕様と設計についてまとめたものである。

Cloud Run functions 関数 `instant2bq` (Golang) として構築され、Cloud Scheduler で定期的に呼び出されることを想定している。

---

## 1. データ仕様

計測データは、以下の要素を含むことを想定している。

簡易化するため、メッセージ本文ではなく、Attributes に以下のフィールドをテキスト形式で格納する。

- **ポイントID (`point_id`)**: 計測点を識別する ID、異なる複数の電力計のデータを扱う際に区別できるようにしている
- **電力値 (`power`)**: 瞬間電力量 (W)
- **タイムスタンプ (`timestamp`)**: 2000-01-01 00:00:00+09:00 (JST) からの経過秒数
  - 送信側の都合でこうなっている

## 2. 背景と目的

秒単位（数秒単位）で生成される高頻度な「瞬間電力量データ」（計測デバイスから取得され補助デバイス等から送信される）を、中長期的な分析のために BigQuery に保存することを目的とする。
本システムは所謂ストリーミング処理ではなく、コストとリソースの効率化を重視し、準リアルタイム処理として「5分に1回のバッチ処理」というアーキテクチャを採用している。
BigQuery への保存は、一度に大量のデータを送信するのではなく、バッチ処理で行うことで、コストを抑えることができる。

## 3. システム構成

1.  **Cloud Scheduler**: 数分間隔（デフォルト: 5分）で Cloud Run functions を呼び出す
2.  **Google Cloud Pub/Sub**: 計測デバイスからのデータを一時的にバッファリングする
3.  **Cloud Run functions (`instant2bq`)**: Pub/Sub サブスクリプションからメッセージを pull し、BigQuery に保存する
4.  **BigQuery**: 最終的なデータ保存先。ストアドプロシージャにより、データの重複登録を防止する

## 4. 設計概要

### 制御用メタデータ

- **UUID**: 各メッセージの処理状況を追跡・制御するために、内部的に UUID を生成して管理する。

### 冪等性の確保

BigQuery 側のストアドプロシージャ（[insert_instant_data_cloud.sql](../bigquery/insert_instant_data_cloud.sql)）内で `MERGE` 文を使用している。
これにより、同じ `point_id` と `timestamp` を持つデータを複数回 pull した場合でも、既存レコードの更新または無視が行われ、重複が発生しないようになっている。タイムアウト等で再送された場合でもデータの不整合は発生しない。

## 5. 信頼性とリソース制御の設計

### メッセージ滞留への対策

バグの混入や一時的なシステム停止により、Pub/Sub に大量のメッセージが滞留（バックログ）することがある。
`instant2bq` は、1回の起動で **「メッセージがなくなるか、タイムアウト（約5分）が近づくまで」** 以下のサイクルを繰り返す仕様である。

1.  **内部バッファへの一時蓄積**: 受信したメッセージは、一意の識別子 (UUID) と共に内部のメモリバッファに一時的に蓄積される。各受信メッセージは、BigQuery への保存結果が返るまで待機状態で保持される
2.  **バッチ処理実行**: メインの処理ループがバッファから最大 `CONCURRENT_MESSAGES` 件のデータを取り出し、1つの BigQuery ジョブとして集約して送信する
3.  **完了通知と応答**: BigQuery ジョブの完了信号を受け取り、バッファ内の各メッセージに対して結果に応じた応答（成功なら `Ack`、失敗なら `Nack`）を返す
4.  **継続的な処理ループ**: クエリ処理完了後、バッファ内に未処理のバックログが残っている場合は、再度バッチ処理を継続する

### 処理上限の設定

1回の BigQuery クエリで処理するメッセージ数には上限（`CONCURRENT_MESSAGES`: デフォルト 4096）を設けている。これには以下の設計上の目的がある：

- **データサイズ制限の回避**: BigQuery のクエリパラメータ（スクリプト変数）が保持できるデータサイズ上限（約 1 MB）を超過しないように制御する
- **リソースの保護**: メモリ使用量を予測可能な範囲に抑え、関数の異常終了 (OOM) を防止する

### タイムアウト管理

Cloud Run functions の最大実行時間を考慮し、残り時間が少なくなった場合には、未処理のメッセージに `Nack` を返して終了する。

## 6. 環境設定

動作には以下の環境変数が必要である。

| 変数名            | 内容                                  | 備考 |
| :---------------- | :------------------------------------ | :--- |
| `PROJECT_ID`      | Google Cloud のプロジェクト ID        |      |
| `SUBSCRIPTION_ID` | Pub/Sub の Pull サブスクリプション ID |      |

## 7. 使用している SQL (`insert_instant_data`)

SQLの詳細は [insert_instant_data_cloud.sql](../bigquery/insert_instant_data_cloud.sql) を参照。
このプロシージャは、引数として受け取ったデータ配列を `MERGE` 文を用いてテーブルに反映する処理を行う。
