# total2bq ドキュメント

本ドキュメントは、スマートメーター等の電力計測デバイスから取得され、Google Cloud Pub/Sub へと送信された「積算電力量データ」を、BigQuery へ効率的かつ安定的に保存するためのシステムの仕様と設計についてまとめたものである。

Cloud Run functions 関数 `total2bq` (Golang) として構築され、メッセージの発生に合わせて呼び出されることを想定している。

---

## 1. データ仕様

計測データは、以下の要素を含むことを想定している。

簡易化するため、メッセージ本文ではなく、Attributes に以下のフィールドをテキスト形式で格納する。

- **ポイントID (`point_id`)**: 計測点を識別する ID、異なる複数の電力計のデータを扱う際に区別できるようにしている
- **電力値 (`power`)**: 積算電力量 (kWh)。文字列形式で受信し、BigQuery 側で `NUMERIC` 型にキャストして保存する
- **タイムスタンプ（`timestamp_str`）**: `YYYY-MM-DD HH:mm:ss` (JST) 形式の文字列
  - 送信側の都合でこうなっている

## 2. 背景と目的

約30分に1度、30分毎の「積算電力量データ」が計測デバイスから取得される。この積算電力量データを、長期間の記録・集計のために BigQuery に保存することを目的とする。
本システムは所謂ストリーミング処理ではなく、Pub/Sub の Push サブスクリプションを介してメッセージをプッシュ受信する方式を採用している。

## 3. システム構成

1.  **Google Cloud Pub/Sub**: 計測デバイスからのデータを受信する
2.  **Push サブスクリプション**: メッセージ受信時に `total2bq` 関数のエンドポイントへ HTTP POST リクエストを送信する
    - イベントトリガーを想定している
3.  **Cloud Run functions (`total2bq`)**: プッシュされたメッセージの内容を BigQuery に保存する
4.  **BigQuery**: 最終的なデータ保存先。ストアドプロシージャにより、データの重複登録を防止する

## 4. 設計概要

### 冪等性の確保

BigQuery 側のストアドプロシージャ（[insert_total_data.sql](../bigquery/insert_total_data.sql)）内で `MERGE` 文を使用している。
これにより、同じ `point_id` と `timestamp` を持つデータが重複して送られてきた場合でも、既存レコードの更新が行われ、データの一貫性が保たれるようになっている。

## 5. 運用上の注意・特徴的な仕様

### instant2bq との違い

`instant2bq` が Cloud Scheduler を起点にメッセージを pull する「プル型」であるのに対し、`total2bq` はメッセージの発生に合わせて Push 起動される「プッシュ型」である。
そのため、`instant2bq` のようなメッセージ滞留解消のための内部ループ処理（複数回クエリ実行）は持たない。

### エラーハンドリングとリトライ

処理に失敗した場合（BigQuery への保存失敗など）は、エラーレスポンスを返すことで、Pub/Sub 側のリトライポリシーに従った再送が行われる。

## 6. 環境設定

動作には以下の環境変数が必要である。

| 変数名       | 内容                           | 備考 |
| :----------- | :----------------------------- | :--- |
| `PROJECT_ID` | Google Cloud のプロジェクト ID |      |

## 7. 使用している SQL (`insert_total_data`)

SQLの詳細は [insert_total_data.sql](../bigquery/insert_total_data.sql) を参照。
このプロシージャは、引数として受け取ったデータ配列を `MERGE` 文を用いてテーブルに反映する処理を行う。
